<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bartender Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #fff; margin: 0; min-height: 100vh; }
        
        .header { background: rgba(255,255,255,0.05); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .header h1 { margin: 0; font-size: 24px; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .user-info { color: #888; font-size: 14px; }
        
        .btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; text-decoration: none; display: inline-block; }
        .btn-logout { background: rgba(237, 66, 69, 0.2); color: #ed4245; }
        .btn-logout:hover { background: rgba(237, 66, 69, 0.3); }
        .btn-success { background: #3ba55c; color: #fff; }
        .btn-success:hover { background: #2d8049; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        
        .stats-row { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { flex: 1; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 24px; text-align: center; }
        .stat-value { font-size: 36px; font-weight: 700; color: #3ba55c; }
        .stat-label { color: #888; font-size: 14px; margin-top: 8px; }
        
        .card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 24px; }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: #888; font-size: 13px; margin-bottom: 8px; text-transform: uppercase; }
        .form-group select, .form-group input {
            width: 100%; padding: 12px 14px; background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 14px;
        }
        .form-group select:focus, .form-group input:focus { outline: none; border-color: #5865f2; }
        .form-group select option { background: #1a1a2e; color: #fff; }
        .form-hint { font-size: 11px; color: #888; margin-top: 6px; }
        
        .btn-generate { 
            width: 100%; padding: 14px; background: #3ba55c; color: #fff; 
            font-size: 16px; font-weight: 600; border-radius: 8px; margin-top: 10px;
        }
        .btn-generate:hover { background: #2d8049; }
        .btn-generate:disabled { background: #666; cursor: not-allowed; }
        
        .queue-status { background: rgba(88, 101, 242, 0.1); border: 1px solid rgba(88, 101, 242, 0.3); border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .queue-status-item { text-align: center; }
        .queue-status-label { font-size: 11px; color: #888; text-transform: uppercase; }
        .queue-status-value { font-size: 14px; font-weight: 600; color: #5865f2; }
        .queue-status-value.processing { color: #faa61a; }
        .queue-status-value.idle { color: #3ba55c; }
        
        .progress-container { display: none; margin-top: 20px; }
        .progress-container.active { display: block; }
        .progress-bar-wrapper { background: rgba(255,255,255,0.1); border-radius: 8px; height: 8px; overflow: hidden; }
        .progress-bar { background: linear-gradient(90deg, #5865f2, #3ba55c); height: 100%; width: 0%; transition: width 0.3s ease; }
        .progress-text { font-size: 13px; color: #888; margin-top: 10px; text-align: center; }
        
        .result-container { display: none; margin-top: 20px; }
        .result-container.active { display: block; }
        .result-success { background: rgba(59, 165, 92, 0.1); border: 1px solid rgba(59, 165, 92, 0.3); border-radius: 8px; padding: 20px; text-align: center; }
        .result-error { background: rgba(237, 66, 69, 0.1); border: 1px solid rgba(237, 66, 69, 0.3); border-radius: 8px; padding: 20px; text-align: center; }
        .result-icon { font-size: 40px; margin-bottom: 10px; }
        .result-message { font-size: 16px; font-weight: 600; margin-bottom: 10px; }
        .result-details { font-size: 13px; color: #888; margin-bottom: 15px; }
        .download-link { display: inline-block; background: #3ba55c; color: #fff; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; }
        .download-link:hover { background: #2d8049; }
        
        .files-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .files-table th, .files-table td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .files-table th { color: #888; font-size: 12px; text-transform: uppercase; font-weight: 500; }
        .files-table td { font-size: 13px; }
        
        .empty-state { text-align: center; padding: 40px; color: #888; }
        .empty-state-icon { font-size: 48px; margin-bottom: 10px; }
        
        .alert { padding: 14px 18px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        .alert-success { background: rgba(59, 165, 92, 0.2); border: 1px solid rgba(59, 165, 92, 0.5); color: #3ba55c; }
        .alert-error { background: rgba(237, 66, 69, 0.2); border: 1px solid rgba(237, 66, 69, 0.5); color: #ed4245; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üç∫ Bartender Dashboard</h1>
        <div class="header-right">
            <span class="user-info">Logged in as <strong><%= user && user.displayName ? user.displayName : (user && user.username ? user.username : 'Unknown') %></strong></span>
            <a href="/dashboard/change-password" class="btn" style="background: rgba(255,255,255,0.1);">Change Password</a>
            <a href="/dashboard/logout" class="btn btn-logout">Logout</a>
        </div>
    </div>
    
    <div class="container">
        <% if (typeof success !== 'undefined' && success) { %>
            <div class="alert alert-success">‚úÖ <%= success %></div>
        <% } %>
        <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-error">‚ùå <%= error %></div>
        <% } %>
        
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value"><%= stats.availableTokens %></div>
                <div class="stat-label">Available Tokens</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #faa61a;"><%= stats.openTickets %></div>
                <div class="stat-label">Open Tickets</div>
            </div>
        </div>
        
        <div class="grid">
            <!-- Generation Form -->
            <div class="card">
                <h2 class="card-title">‚ö° Generate Token</h2>
                
                <!-- Queue Status -->
                <div class="queue-status">
                    <div class="queue-status-item">
                        <div class="queue-status-label">Status</div>
                        <div class="queue-status-value <%= queueStatus.isProcessing ? 'processing' : 'idle' %>" id="queueStatusText">
                            <%= queueStatus.isProcessing ? 'üîÑ Processing' : '‚úÖ Idle' %>
                        </div>
                    </div>
                    <div class="queue-status-item">
                        <div class="queue-status-label">Queue</div>
                        <div class="queue-status-value" id="queueLength"><%= queueStatus.queueLength %></div>
                    </div>
                </div>
                
                <form id="generateForm">
                    <div class="form-group">
                        <label>Select Game</label>
                        <select name="game_id" id="gameSelect" required>
                            <option value="">Choose a game...</option>
                            <% games.forEach(function(game) { %>
                                <option value="<%= game.id %>" data-folder="<%= game.folder_name || game.game_name %>">
                                    <%= game.game_name %> (<%= game.available %> available)
                                </option>
                            <% }); %>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Select Account</label>
                        <select name="account_id" id="accountSelect">
                            <option value="any" data-name="Auto-select">üé≤ Any Available Account (Recommended)</option>
                            <option value="" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                            <% accounts.forEach(function(account) { %>
                                <option value="<%= account.id %>" data-name="<%= account.account_name %>">
                                    #<%= account.account_number %> - <%= account.account_name %>
                                </option>
                            <% }); %>
                        </select>
                        <div class="form-hint">Use "Any Available" to auto-select an account with tokens for this game</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Steam ID (Optional - for refills)</label>
                        <input type="text" name="steam_id" id="steamIdInput" placeholder="76561199xxxxxxxxx" pattern="7656119\d{10}">
                        <div class="form-hint">Leave empty for new activations. Enter Steam ID for refills.</div>
                    </div>
                    
                    <button type="submit" class="btn btn-generate" id="generateBtn">
                        ‚ö° Generate Token
                    </button>
                </form>
                
                <!-- Progress -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <p class="progress-text" id="progressText">Generating activation token...</p>
                </div>
                
                <!-- Result -->
                <div class="result-container" id="resultContainer">
                    <!-- Filled by JavaScript -->
                </div>
            </div>
            
            <!-- Generated Files -->
            <div class="card">
                <h2 class="card-title">üìÅ Generated Files <span style="font-size: 12px; color: #888; font-weight: normal;">(auto-delete after 20 min)</span></h2>
                
                <% if (files && files.length > 0) { %>
                <table class="files-table">
                    <thead>
                        <tr>
                            <th>File</th>
                            <th>Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% files.forEach(file => { %>
                        <tr>
                            <td><%= file.fileName %></td>
                            <td><%= file.sizeFormatted %></td>
                            <td>
                                <a href="/dashboard/bartender/download/<%= encodeURIComponent(file.fileName) %>" 
                                   class="btn btn-success btn-sm">‚¨áÔ∏è Download</a>
                            </td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
                <% } else { %>
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <p>No generated files yet</p>
                    <p style="font-size: 13px; margin-top: 8px;">Generated ZIP files will appear here</p>
                </div>
                <% } %>
            </div>
        </div>
    </div>
    
    <script>
        const form = document.getElementById('generateForm');
        const generateBtn = document.getElementById('generateBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const resultContainer = document.getElementById('resultContainer');
        
        // Poll queue status every 3 seconds
        setInterval(async () => {
            try {
                const res = await fetch('/dashboard/bartender/status');
                const data = await res.json();
                
                document.getElementById('queueStatusText').textContent = 
                    data.isProcessing ? 'üîÑ Processing' : '‚úÖ Idle';
                document.getElementById('queueStatusText').className = 
                    'queue-status-value ' + (data.isProcessing ? 'processing' : 'idle');
                document.getElementById('queueLength').textContent = data.queueLength;
            } catch (e) {
                console.error('Failed to fetch queue status:', e);
            }
        }, 3000);
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const gameSelect = document.getElementById('gameSelect');
            const accountSelect = document.getElementById('accountSelect');
            const steamIdInput = document.getElementById('steamIdInput');
            
            const gameId = gameSelect.value;
            const accountId = accountSelect.value;
            const steamId = steamIdInput.value.trim();
            
            if (!gameId) {
                alert('Please select a game');
                return;
            }
            
            const gameName = gameSelect.options[gameSelect.selectedIndex].text;
            const accountName = accountSelect.options[accountSelect.selectedIndex].dataset.name;
            
            // Show progress
            generateBtn.disabled = true;
            progressContainer.classList.add('active');
            resultContainer.classList.remove('active');
            progressBar.style.width = '10%';
            progressText.textContent = `Queuing generation for ${gameName}...`;
            
            // Animate progress bar
            let progress = 10;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 5;
                    progressBar.style.width = progress + '%';
                }
            }, 500);
            
            try {
                const res = await fetch('/dashboard/bartender/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ game_id: gameId, account_id: accountId, steam_id: steamId })
                });
                
                const data = await res.json();
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    progressContainer.classList.remove('active');
                    resultContainer.classList.add('active');
                    
                    if (data.success) {
                        resultContainer.innerHTML = `
                            <div class="result-success">
                                <div class="result-icon">‚úÖ</div>
                                <div class="result-message">Token Generated Successfully!</div>
                                <div class="result-details">
                                    Game: ${data.gameName}<br>
                                    Account: ${data.accountName}<br>
                                    Duration: ${data.duration}s
                                </div>
                                <a href="/dashboard/bartender/download/${encodeURIComponent(data.fileName)}" class="download-link">
                                    ‚¨áÔ∏è Download ZIP
                                </a>
                            </div>
                        `;
                        // Refresh file list after 2 seconds
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        resultContainer.innerHTML = `
                            <div class="result-error">
                                <div class="result-icon">‚ùå</div>
                                <div class="result-message">Generation Failed</div>
                                <div class="result-details">${data.error || 'Unknown error'}</div>
                            </div>
                        `;
                    }
                    
                    generateBtn.disabled = false;
                }, 500);
                
            } catch (err) {
                clearInterval(progressInterval);
                progressContainer.classList.remove('active');
                resultContainer.classList.add('active');
                resultContainer.innerHTML = `
                    <div class="result-error">
                        <div class="result-icon">‚ùå</div>
                        <div class="result-message">Request Failed</div>
                        <div class="result-details">${err.message}</div>
                    </div>
                `;
                generateBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
