<%- include('partials/header', { title: title }) %>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-chart-bar"></i> <%= analytics.gameName %></h1>
        <div class="d-flex gap-2">
            <span class="badge bg-<%= analytics.platform === 'steam' ? 'info' : analytics.platform === 'ea' ? 'warning' : 'success' %> fs-5">
                <%= analytics.platform.toUpperCase() %>
            </span>
            <a href="/dashboard/game-health" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Health
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3><%= analytics.stats.total_activations || 0 %></h3>
                    <p class="mb-0">Total Activations</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3><%= analytics.stats.unique_users || 0 %></h3>
                    <p class="mb-0">Unique Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-<%= analytics.ghostRate > 20 ? 'danger' : analytics.ghostRate > 10 ? 'warning' : 'info' %> text-white">
                <div class="card-body text-center">
                    <h3><%= analytics.ghostRate %>%</h3>
                    <p class="mb-0">Ghost Rate</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <h3><%= analytics.stats.avg_duration ? Math.round(analytics.stats.avg_duration) + ' min' : 'N/A' %></h3>
                    <p class="mb-0">Avg Duration</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Daily Chart -->
        <div class="col-md-8 mb-4">
            <div class="card">
                <div class="card-header"><i class="fas fa-chart-line"></i> Daily Activations</div>
                <div class="card-body">
                    <canvas id="dailyChart" height="150"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Users -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header"><i class="fas fa-users"></i> Top Users for This Game</div>
                <div class="card-body">
                    <% if (analytics.topUsers && analytics.topUsers.length > 0) { %>
                    <table class="table table-sm">
                        <tbody>
                            <% analytics.topUsers.forEach(function(user, index) { %>
                            <tr>
                                <td>
                                    <% if (index === 0) { %>
                                        <i class="fas fa-crown text-warning"></i>
                                    <% } else { %>
                                        #<%= index + 1 %>
                                    <% } %>
                                </td>
                                <td>
                                    <a href="/dashboard/user/<%= user.user_id %>"><%= user.username %></a>
                                </td>
                                <td class="text-end">
                                    <span class="badge bg-primary"><%= user.count %></span>
                                </td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                    <% } else { %>
                    <p class="text-muted">No user data available</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header"><i class="fas fa-bolt"></i> Quick Actions</div>
        <div class="card-body">
            <div class="btn-group">
                <a href="/dashboard/<%= analytics.platform %>/tokens" class="btn btn-outline-primary">
                    <i class="fas fa-coins"></i> Manage Tokens
                </a>
                <a href="/dashboard/<%= analytics.platform %>/games" class="btn btn-outline-secondary">
                    <i class="fas fa-gamepad"></i> Game Settings
                </a>
                <a href="/dashboard/<%= analytics.platform %>/transcripts" class="btn btn-outline-info">
                    <i class="fas fa-file-alt"></i> View Transcripts
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const dailyData = <%- JSON.stringify(analytics.dailyStats || []) %>;

new Chart(document.getElementById('dailyChart'), {
    type: 'line',
    data: {
        labels: dailyData.map(d => d.date),
        datasets: [{
            label: 'Activations',
            data: dailyData.map(d => d.activations),
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            fill: true
        }]
    },
    options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
    }
});
</script>

<%- include('partials/footer') %>
