<%- include('../partials/header') %>

<style>
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    .quantity-selector {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .quantity-btn {
        width: 36px;
        height: 36px;
        border: 1px solid var(--border);
        background: var(--card-bg);
        color: var(--text);
        border-radius: 6px;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .quantity-btn:hover { background: var(--bg); }
    .quantity-input {
        width: 60px;
        text-align: center;
        font-size: 16px;
        font-weight: bold;
    }
    .btn.loading {
        opacity: 0.7;
        pointer-events: none;
    }
    .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
    }
    .card-danger {
        border-color: var(--danger);
    }
    .card-danger .card-header {
        background: rgba(220, 53, 69, 0.1);
    }
    .stats-row {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
    }
    .stats-row .stat {
        text-align: center;
    }
    .stats-row .stat .value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .stats-row .stat .label {
        color: var(--text-muted);
        font-size: 0.85rem;
    }
</style>

<div class="page-header">
    <h1 class="page-title">
        <span class="icon">‚ûï</span>
        Add Steam Tokens
    </h1>
    <div class="page-actions">
        <a href="/dashboard/steam/tokens" class="btn btn-secondary">‚Üê Back to Tokens</a>
    </div>
</div>

<div class="grid-2">
    <!-- Add Single Token(s) -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">üé´ Add Tokens</span>
        </div>
        <div class="card-body">
            <p style="color: var(--text-muted); margin-bottom: 16px;">
                Add tokens for a specific game to a specific account.
            </p>
            <form id="addSingleForm">
                <div class="form-group">
                    <label class="form-label">Select Game</label>
                    <select name="game_id" id="singleGameId" class="form-control" required>
                        <option value="">Choose a game...</option>
                        <% games.forEach(g => { %>
                        <option value="<%= g.id %>"><%= g.game_name %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Select Account</label>
                    <select name="account_id" id="singleAccountId" class="form-control" required>
                        <option value="">Choose an account...</option>
                        <% accounts.forEach(a => { %>
                        <option value="<%= a.id %>">#<%= a.account_number %> - <%= a.account_name || a.email || 'Unknown' %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity</label>
                    <div class="quantity-selector">
                        <button type="button" class="quantity-btn" onclick="adjustQuantity('single', -1)">‚àí</button>
                        <input type="number" name="quantity" id="singleQuantity" class="form-control quantity-input" value="1" min="1" max="10" readonly>
                        <button type="button" class="quantity-btn" onclick="adjustQuantity('single', 1)">+</button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" id="addSingleBtn">‚ûï Add Token(s)</button>
            </form>
        </div>
    </div>
    
    <!-- Add Game to All Accounts -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">üéÆ Add Game to All Accounts</span>
        </div>
        <div class="card-body">
            <p style="color: var(--text-muted); margin-bottom: 16px;">
                Create token slots for a specific game across ALL accounts.<br>
                <strong>Use when:</strong> Adding a new game to the system.
            </p>
            <form id="addGameForm">
                <div class="form-group">
                    <label class="form-label">Select Game</label>
                    <select name="game_id" id="bulkGameId" class="form-control" required>
                        <option value="">Choose a game...</option>
                        <% games.forEach(g => { %>
                        <option value="<%= g.id %>"><%= g.game_name %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tokens per Account</label>
                    <input type="number" name="token_count" id="bulkTokenCount" class="form-control" value="1" min="1" max="10">
                    <small style="color: var(--text-muted);">Usually 1 token per account</small>
                </div>
                <button type="submit" class="btn btn-primary" id="addGameBtn">
                    ‚ûï Add to All Accounts (<%= accounts.length %>)
                </button>
            </form>
        </div>
    </div>
    
    <!-- Add All Games to Account -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">üë§ Add All Games to Account</span>
        </div>
        <div class="card-body">
            <p style="color: var(--text-muted); margin-bottom: 16px;">
                Create token slots for ALL games on a specific account.<br>
                <strong>Use when:</strong> Adding a new account to the system.
            </p>
            <form id="addAccountForm">
                <div class="form-group">
                    <label class="form-label">Select Account</label>
                    <select name="account_id" id="bulkAccountId" class="form-control" required>
                        <option value="">Choose an account...</option>
                        <% accounts.forEach(a => { %>
                        <option value="<%= a.id %>">#<%= a.account_number %> - <%= a.account_name || a.email || 'Unknown' %></option>
                        <% }) %>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" id="addAccountBtn">
                    ‚ûï Add All Games (<%= games.length %>)
                </button>
            </form>
        </div>
    </div>
    
    <!-- Current Stats -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">üìä Current Stats</span>
        </div>
        <div class="card-body">
            <div class="stats-row">
                <div class="stat">
                    <div class="value"><%= games.length %></div>
                    <div class="label">Total Games</div>
                </div>
                <div class="stat">
                    <div class="value"><%= accounts.length %></div>
                    <div class="label">Total Accounts</div>
                </div>
                <div class="stat">
                    <div class="value"><%= games.length * accounts.length %></div>
                    <div class="label">Max Possible Tokens</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Section -->
<div class="card card-danger" style="margin-top: 1.5rem;">
    <div class="card-header">
        <span class="card-title">üóëÔ∏è Delete Tokens</span>
    </div>
    <div class="card-body">
        <p style="color: var(--text-muted); margin-bottom: 16px;">
            Remove all tokens for a specific game from a specific account.<br>
            <strong>Use when:</strong> Removing a game from an account in omega.exe.
        </p>
        <form id="deleteForm">
            <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                    <label class="form-label">Select Game</label>
                    <select name="game_id" id="deleteGameId" class="form-control" required>
                        <option value="">Choose a game...</option>
                        <% games.forEach(g => { %>
                        <option value="<%= g.id %>"><%= g.game_name %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                    <label class="form-label">Select Account</label>
                    <select name="account_id" id="deleteAccountId" class="form-control" required>
                        <option value="">Choose an account...</option>
                        <% accounts.forEach(a => { %>
                        <option value="<%= a.id %>">#<%= a.account_number %> - <%= a.account_name || a.email || 'Unknown' %></option>
                        <% }) %>
                    </select>
                </div>
                <button type="submit" class="btn btn-danger" id="deleteBtn">
                    üóëÔ∏è Delete Tokens
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Quantity selector
    function adjustQuantity(type, delta) {
        const input = document.getElementById(type + 'Quantity');
        let val = parseInt(input.value) + delta;
        if (val < 1) val = 1;
        if (val > 10) val = 10;
        input.value = val;
    }
    
    // Toast notification
    function showToast(message, type = 'success') {
        const existing = document.querySelector('.toast');
        if (existing) existing.remove();
        
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.remove(), 4000);
    }
    
    // Add Single Token(s)
    document.getElementById('addSingleForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('addSingleBtn');
        const gameId = document.getElementById('singleGameId').value;
        const accountId = document.getElementById('singleAccountId').value;
        const quantity = document.getElementById('singleQuantity').value;
        
        if (!gameId || !accountId) {
            showToast('Please select game and account', 'error');
            return;
        }
        
        btn.classList.add('loading');
        btn.textContent = 'Adding...';
        
        try {
            const res = await fetch('/dashboard/steam/tokens/add-single-ajax', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ game_id: gameId, account_id: accountId, quantity: parseInt(quantity) })
            });
            const data = await res.json();
            
            if (data.success) {
                showToast('‚úÖ Added ' + data.added + ' token(s)!', 'success');
            } else {
                showToast(data.error || 'Failed to add tokens', 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
        
        btn.classList.remove('loading');
        btn.textContent = '‚ûï Add Token(s)';
    });
    
    // Add Game to All Accounts
    document.getElementById('addGameForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('addGameBtn');
        const gameId = document.getElementById('bulkGameId').value;
        const tokenCount = document.getElementById('bulkTokenCount').value;
        
        if (!gameId) {
            showToast('Please select a game', 'error');
            return;
        }
        
        if (!confirm('Add this game to ALL accounts?')) return;
        
        btn.classList.add('loading');
        btn.textContent = 'Adding...';
        
        try {
            const res = await fetch('/dashboard/steam/tokens/bulk-add-game-ajax', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ game_id: gameId, token_count: parseInt(tokenCount) })
            });
            const data = await res.json();
            
            if (data.success) {
                showToast('‚úÖ Added ' + data.added + ' tokens to ' + data.accounts + ' accounts!', 'success');
            } else {
                showToast(data.error || 'Failed to add tokens', 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
        
        btn.classList.remove('loading');
        btn.textContent = '‚ûï Add to All Accounts (<%= accounts.length %>)';
    });
    
    // Add All Games to Account
    document.getElementById('addAccountForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('addAccountBtn');
        const accountId = document.getElementById('bulkAccountId').value;
        
        if (!accountId) {
            showToast('Please select an account', 'error');
            return;
        }
        
        if (!confirm('Add ALL games to this account?')) return;
        
        btn.classList.add('loading');
        btn.textContent = 'Adding...';
        
        try {
            const res = await fetch('/dashboard/steam/tokens/bulk-add-account-ajax', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ account_id: accountId })
            });
            const data = await res.json();
            
            if (data.success) {
                showToast('‚úÖ Added ' + data.added + ' tokens for ' + data.games + ' games!', 'success');
            } else {
                showToast(data.error || 'Failed to add tokens', 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
        
        btn.classList.remove('loading');
        btn.textContent = '‚ûï Add All Games (<%= games.length %>)';
    });
    
    // Delete Tokens
    document.getElementById('deleteForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('deleteBtn');
        const gameId = document.getElementById('deleteGameId').value;
        const accountId = document.getElementById('deleteAccountId').value;
        
        if (!gameId || !accountId) {
            showToast('Please select game and account', 'error');
            return;
        }
        
        if (!confirm('‚ö†Ô∏è Delete ALL tokens for this game on this account?\n\nThis cannot be undone!')) return;
        
        btn.classList.add('loading');
        btn.textContent = 'Deleting...';
        
        try {
            const res = await fetch('/dashboard/steam/tokens/delete-game-account-ajax', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ game_id: gameId, account_id: accountId })
            });
            const data = await res.json();
            
            if (data.success) {
                showToast('‚úÖ Deleted ' + data.deleted + ' token(s)!', 'success');
            } else {
                showToast(data.error || 'Failed to delete tokens', 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
        
        btn.classList.remove('loading');
        btn.textContent = 'üóëÔ∏è Delete Tokens';
    });
</script>

<%- include('../partials/footer') %>
