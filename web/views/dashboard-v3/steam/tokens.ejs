<%- include('../partials/header') %>

<style>
    .timer { font-family: monospace; font-weight: bold; }
    .timer.ready { color: var(--success); }
    .timer.soon { color: var(--warning); }
    .timer.waiting { color: var(--text-muted); }
    .btn-reset { padding: 4px 8px; font-size: 11px; }
    .stats-bar {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
    }
    .stat-box {
        background: var(--card-bg);
        padding: 1rem 1.5rem;
        border-radius: 8px;
        text-align: center;
        min-width: 100px;
    }
    .stat-box .value { font-size: 1.5rem; font-weight: bold; }
    .stat-box .label { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
    .success-banner {
        background: rgba(35, 165, 89, 0.2);
        border: 1px solid var(--success);
        color: var(--success);
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 16px;
    }
    .badge-reserved { background: #5865F2; color: white; }
    .bulk-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 1rem; }
    .filters-row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; margin-bottom: 1.5rem; }
    .filters-row .form-group { flex: 1; min-width: 150px; }
    .pagination { display: flex; justify-content: center; gap: 1rem; align-items: center; margin-top: 1.5rem; }
    .pagination a { color: var(--primary); text-decoration: none; padding: 8px 16px; background: var(--card-bg); border-radius: 6px; }
    .pagination a:hover { background: var(--primary); color: white; }
    .pagination .active { color: var(--text-muted); }
</style>

<div class="page-header">
    <h1 class="page-title">
        <span class="icon">ğŸŸï¸</span>
        Steam Tokens
    </h1>
    <div class="page-actions">
        <a href="/dashboard/steam/tokens/add" class="btn btn-success">â• Add Tokens</a>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const success = params.get('success');
    if (success) {
        const messages = {
            'reset': 'âœ… Token reset successfully!',
            'reset-all': 'âœ… All tokens reset successfully!',
            'reset-filtered': 'âœ… Filtered tokens reset successfully!',
            'released-reserved': 'ğŸ”“ All reserved tokens released!',
            'used': 'â±ï¸ Token marked as used!',
            'used-all': 'â±ï¸ All tokens marked as used!',
            'deleted': 'ğŸ—‘ï¸ Token deleted successfully!',
            'deleted-game-account': 'ğŸ—‘ï¸ Deleted ' + (params.get('count') || '?') + ' tokens!'
        };
        if (messages[success]) {
            document.write('<div class="success-banner">' + messages[success] + '</div>');
        }
        // Clean URL
        window.history.replaceState({}, '', window.location.pathname + '?' + 
            Array.from(params.entries()).filter(([k]) => !['success', 'count'].includes(k)).map(([k,v]) => k + '=' + v).join('&'));
    }
</script>

<!-- Stats Bar -->
<div class="stats-bar">
    <div class="stat-box">
        <div class="value" style="color: var(--success);"><%= typeof regenStats !== 'undefined' ? regenStats.available : (stats ? stats.available : 0) %></div>
        <div class="label">Available</div>
    </div>
    <div class="stat-box">
        <div class="value" style="color: #5865F2;"><%= typeof regenStats !== 'undefined' ? (regenStats.reserved || 0) : 0 %></div>
        <div class="label">ğŸ”’ Reserved</div>
    </div>
    <div class="stat-box">
        <div class="value" style="color: var(--warning);"><%= typeof regenStats !== 'undefined' ? regenStats.regenerating : (stats ? stats.used : 0) %></div>
        <div class="label">Regenerating</div>
    </div>
    <div class="stat-box">
        <div class="value" style="color: #5865F2;"><%= typeof regenStats !== 'undefined' ? regenStats.within1h : 0 %></div>
        <div class="label">Ready &lt;1h</div>
    </div>
    <div class="stat-box">
        <div class="value"><%= typeof regenStats !== 'undefined' ? regenStats.within6h : 0 %></div>
        <div class="label">Ready &lt;6h</div>
    </div>
    <div class="stat-box">
        <div class="value" style="color: var(--primary);"><%= typeof regenStats !== 'undefined' ? (regenStats.available + regenStats.regenerating + (regenStats.reserved || 0)) : (stats ? stats.total : (tokens ? tokens.length : 0)) %></div>
        <div class="label">Total</div>
    </div>
</div>

<!-- Bulk Actions -->
<div class="bulk-actions">
    <form method="POST" action="/dashboard/steam/tokens/release-reserved" style="display: inline;" 
          onsubmit="return confirm('ğŸ”“ Release ALL reserved tokens back to available?');">
        <button type="submit" class="btn btn-secondary">ğŸ”“ Release Reserved</button>
    </form>
    <form method="POST" action="/dashboard/steam/tokens/use-all" style="display: inline;" 
          onsubmit="return confirm('âš ï¸ Mark ALL available tokens as used? (Testing only)');">
        <input type="hidden" name="game" value="<%= typeof filters !== 'undefined' ? (filters.game || '') : (selectedGame || '') %>">
        <input type="hidden" name="status" value="<%= typeof filters !== 'undefined' ? (filters.status || '') : (selectedStatus || '') %>">
        <input type="hidden" name="account" value="<%= typeof filters !== 'undefined' ? (filters.account || '') : (selectedAccount || '') %>">
        <button type="submit" class="btn btn-warning">â±ï¸ Use All</button>
    </form>
    <form method="POST" action="/dashboard/steam/tokens/reset-all" style="display: inline;" 
          onsubmit="return confirm('âš ï¸ Reset ALL tokens to available?');">
        <input type="hidden" name="game" value="<%= typeof filters !== 'undefined' ? (filters.game || '') : (selectedGame || '') %>">
        <input type="hidden" name="status" value="<%= typeof filters !== 'undefined' ? (filters.status || '') : (selectedStatus || '') %>">
        <input type="hidden" name="account" value="<%= typeof filters !== 'undefined' ? (filters.account || '') : (selectedAccount || '') %>">
        <button type="submit" class="btn btn-success">ğŸ”„ Reset All</button>
    </form>
    <% 
    const hasFilters = (typeof filters !== 'undefined' && (filters.game || filters.status || filters.account)) || 
                       (selectedGame || selectedStatus || selectedAccount);
    if (hasFilters) { %>
    <form method="POST" action="/dashboard/steam/tokens/reset-filtered" style="display: inline;">
        <input type="hidden" name="game" value="<%= typeof filters !== 'undefined' ? (filters.game || '') : (selectedGame || '') %>">
        <input type="hidden" name="status" value="<%= typeof filters !== 'undefined' ? (filters.status || '') : (selectedStatus || '') %>">
        <input type="hidden" name="account" value="<%= typeof filters !== 'undefined' ? (filters.account || '') : (selectedAccount || '') %>">
        <button type="submit" class="btn btn-secondary" onclick="return confirm('Reset filtered tokens?');">
            ğŸ”„ Reset Filtered
        </button>
    </form>
    <% } %>
</div>

<!-- Filters -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Filter Tokens</span>
    </div>
    <form method="GET" action="/dashboard/steam/tokens">
        <div class="filters-row">
            <div class="form-group">
                <label class="form-label">Game</label>
                <select name="game" class="form-control">
                    <option value="">All Games</option>
                    <% games.forEach(g => { %>
                    <option value="<%= g.id %>" <%= (typeof filters !== 'undefined' ? filters.game : selectedGame) == g.id ? 'selected' : '' %>><%= g.game_name %></option>
                    <% }); %>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Account</label>
                <select name="account" class="form-control">
                    <option value="">All Accounts</option>
                    <% if (typeof accounts !== 'undefined') { accounts.forEach(a => { %>
                    <option value="<%= a.id %>" <%= (typeof filters !== 'undefined' ? filters.account : selectedAccount) == a.id ? 'selected' : '' %>>#<%= a.account_number %> - <%= a.account_name || a.email || 'Unknown' %></option>
                    <% }); } %>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select name="status" class="form-control">
                    <option value="">All</option>
                    <option value="available" <%= (typeof filters !== 'undefined' ? filters.status : selectedStatus) === 'available' ? 'selected' : '' %>>Available</option>
                    <option value="reserved" <%= (typeof filters !== 'undefined' ? filters.status : selectedStatus) === 'reserved' ? 'selected' : '' %>>ğŸ”’ Reserved</option>
                    <option value="used" <%= (typeof filters !== 'undefined' ? filters.status : selectedStatus) === 'used' ? 'selected' : '' %>>Used/Regenerating</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary">ğŸ” Filter</button>
            </div>
        </div>
    </form>
</div>

<!-- Tokens Table -->
<div class="card">
    <% if (tokens && tokens.length > 0) { %>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Game</th>
                    <th>Account</th>
                    <th>Slot</th>
                    <th>Status</th>
                    <th>Regen Timer / Ticket</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% tokens.forEach(t => { 
                    const filterGame = typeof filters !== 'undefined' ? (filters.game || '') : (selectedGame || '');
                    const filterStatus = typeof filters !== 'undefined' ? (filters.status || '') : (selectedStatus || '');
                    const filterAccount = typeof filters !== 'undefined' ? (filters.account || '') : (selectedAccount || '');
                %>
                <% 
                    // Determine true status based on regenerates_at
                    const isReserved = !!t.reserved_by_ticket;
                    const isRegenerating = !isReserved && t.regenerates_at && new Date(t.regenerates_at) > new Date();
                    const isAvailable = !isReserved && !isRegenerating;
                %>
                <tr>
                    <td class="font-mono">#<%= t.id %></td>
                    <td><%= t.game_name || t.game_id || '-' %></td>
                    <td><%= t.account_name ? ('#' + (t.account_number || '') + ' - ' + t.account_name) : (t.account_id || '-') %></td>
                    <td><%= t.token_number || '-' %></td>
                    <td>
                        <% if (isReserved) { %>
                        <span class="badge badge-reserved" title="Reserved by <%= t.reserved_by_ticket %>">ğŸ”’ reserved</span>
                        <% } else if (isRegenerating) { %>
                        <span class="badge badge-warning">used</span>
                        <% } else { %>
                        <span class="badge badge-success">available</span>
                        <% } %>
                    </td>
                    <td>
                        <% if (isReserved) { %>
                        <span class="timer" style="color: #5865F2;">ğŸ« <%= t.reserved_by_ticket %></span>
                        <% } else if (isRegenerating) { %>
                        <span class="timer" data-regen="<%= t.regenerates_at %>">Calculating...</span>
                        <% } else { %>
                        <span class="timer ready">âœ… Ready</span>
                        <% } %>
                    </td>
                    <td>
                        <% if (isRegenerating || isReserved) { %>
                        <form method="POST" action="/dashboard/steam/tokens/<%= t.id %>/reset" style="display: inline;">
                            <input type="hidden" name="game" value="<%= filterGame %>">
                            <input type="hidden" name="status" value="<%= filterStatus %>">
                            <input type="hidden" name="account" value="<%= filterAccount %>">
                            <button type="submit" class="btn btn-sm btn-success btn-reset" title="Reset to available">ğŸ”„</button>
                        </form>
                        <% } else { %>
                        <form method="POST" action="/dashboard/steam/tokens/<%= t.id %>/use" style="display: inline;">
                            <input type="hidden" name="game" value="<%= filterGame %>">
                            <input type="hidden" name="status" value="<%= filterStatus %>">
                            <input type="hidden" name="account" value="<%= filterAccount %>">
                            <button type="submit" class="btn btn-sm btn-warning btn-reset" title="Mark as used">â±ï¸</button>
                        </form>
                        <% } %>
                        <form method="POST" action="/dashboard/steam/tokens/<%= t.id %>/delete" style="display: inline; margin-left: 4px;">
                            <input type="hidden" name="game" value="<%= filterGame %>">
                            <input type="hidden" name="status" value="<%= filterStatus %>">
                            <input type="hidden" name="account" value="<%= filterAccount %>">
                            <button type="submit" class="btn btn-sm btn-danger btn-reset" title="Delete" onclick="return confirm('Delete this token?');">ğŸ—‘ï¸</button>
                        </form>
                    </td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
    
    <% if (typeof pagination !== 'undefined' && pagination.totalPages > 1) { 
        const filterGame = typeof filters !== 'undefined' ? (filters.game || '') : (selectedGame || '');
        const filterStatus = typeof filters !== 'undefined' ? (filters.status || '') : (selectedStatus || '');
        const filterAccount = typeof filters !== 'undefined' ? (filters.account || '') : (selectedAccount || '');
    %>
    <div class="pagination">
        <% if (pagination.page > 1) { %>
        <a href="?page=<%= pagination.page - 1 %>&game=<%= filterGame %>&status=<%= filterStatus %>&account=<%= filterAccount %>">â† Prev</a>
        <% } %>
        <span class="active">Page <%= pagination.page %> of <%= pagination.totalPages %></span>
        <% if (pagination.page < pagination.totalPages) { %>
        <a href="?page=<%= pagination.page + 1 %>&game=<%= filterGame %>&status=<%= filterStatus %>&account=<%= filterAccount %>">Next â†’</a>
        <% } %>
    </div>
    <% } %>
    
    <p style="text-align: center; margin-top: 16px; color: var(--text-muted);">
        Showing <%= tokens.length %><%= typeof pagination !== 'undefined' && pagination.totalCount ? ' of ' + pagination.totalCount : '' %> tokens
    </p>
    <% } else { %>
    <div class="empty-state">
        <div class="icon">ğŸŸï¸</div>
        <p>No tokens found.</p>
        <a href="/dashboard/steam/tokens/add" class="btn btn-primary" style="margin-top: 1rem;">â• Add Tokens</a>
    </div>
    <% } %>
</div>

<script>
    function updateTimers() {
        const timers = document.querySelectorAll('.timer[data-regen]');
        const now = new Date().getTime();
        
        timers.forEach(timer => {
            const regenTime = new Date(timer.dataset.regen).getTime();
            const diff = regenTime - now;
            
            if (diff <= 0) {
                timer.innerHTML = 'âœ… Ready!';
                timer.className = 'timer ready';
            } else {
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((diff % (1000 * 60)) / 1000);
                
                if (hours > 0) {
                    timer.innerHTML = hours + 'h ' + mins + 'm ' + secs + 's';
                } else if (mins > 0) {
                    timer.innerHTML = mins + 'm ' + secs + 's';
                } else {
                    timer.innerHTML = secs + 's';
                }
                
                timer.className = diff < 5 * 60 * 1000 ? 'timer soon' : 'timer waiting';
            }
        });
    }
    
    updateTimers();
    setInterval(updateTimers, 1000);
</script>

<%- include('../partials/footer') %>
