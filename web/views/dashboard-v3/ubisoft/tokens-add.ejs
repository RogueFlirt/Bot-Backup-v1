<%- include('../partials/header') %>
<!-- UBISOFT-TOKENS-ADD v1.0 -->

<style>
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    .quantity-selector {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .quantity-btn {
        width: 36px;
        height: 36px;
        border: 1px solid var(--border);
        background: var(--card-bg);
        color: var(--text);
        border-radius: 6px;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .quantity-btn:hover { background: var(--bg); }
    .quantity-input {
        width: 60px;
        text-align: center;
        font-size: 16px;
        font-weight: bold;
    }
    .btn.loading {
        opacity: 0.7;
        pointer-events: none;
    }
</style>

<div class="page-header">
    <h1 class="page-title">
        <span class="icon">‚ûï</span>
        Add Ubisoft Tokens
    </h1>
    <div class="page-actions">
        <a href="/dashboard/ubisoft/tokens" class="btn btn-secondary">‚Üê Back to Tokens</a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <span class="card-title">üé´ Add Tokens</span>
    </div>
    <div class="card-body">
        <p style="color: var(--text-muted); margin-bottom: 16px;">
            Add token slots for a specific game to a specific account.
        </p>
        <form id="addTokensForm">
            <div class="form-group">
                <label class="form-label">Game</label>
                <select name="game" id="gameSelect" class="form-control" required>
                    <option value="">Select Game...</option>
                    <% if (typeof games !== 'undefined') { games.forEach(g => { %>
                    <option value="<%= g.id %>"><%= g.game_name %></option>
                    <% }); } %>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Account</label>
                <select name="account" id="accountSelect" class="form-control" required>
                    <option value="">Select Account...</option>
                    <% if (typeof accounts !== 'undefined') { accounts.forEach(a => { %>
                    <option value="<%= a.id %>"><%= a.account_name || 'Account ' + a.id %></option>
                    <% }); } %>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Quantity</label>
                <div class="quantity-selector">
                    <button type="button" class="quantity-btn" onclick="changeQty(-1)">‚àí</button>
                    <input type="number" name="quantity" id="quantityInput" class="form-control quantity-input" value="1" min="1" max="100">
                    <button type="button" class="quantity-btn" onclick="changeQty(1)">+</button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="setQty(5)">+5</button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="setQty(10)">+10</button>
                </div>
            </div>
            <button type="submit" class="btn btn-success" id="addBtn">‚ûï Add Tokens</button>
        </form>
    </div>
</div>

<div id="toastContainer"></div>

<script>
function changeQty(delta) {
    const input = document.getElementById('quantityInput');
    let val = parseInt(input.value) || 1;
    val = Math.max(1, Math.min(100, val + delta));
    input.value = val;
}

function setQty(val) {
    document.getElementById('quantityInput').value = val;
}

function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

document.getElementById('addTokensForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = document.getElementById('addBtn');
    btn.classList.add('loading');
    btn.textContent = '‚è≥ Adding...';
    
    try {
        const formData = new FormData(this);
        const response = await fetch('/dashboard/ubisoft/tokens/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                game: formData.get('game'),
                account: formData.get('account'),
                quantity: parseInt(formData.get('quantity'))
            })
        });
        
        const result = await response.json();
        if (result.success) {
            showToast('‚úÖ Added ' + result.count + ' tokens!', 'success');
        } else {
            showToast('‚ùå ' + (result.error || 'Failed to add tokens'), 'error');
        }
    } catch (err) {
        showToast('‚ùå Error: ' + err.message, 'error');
    }
    
    btn.classList.remove('loading');
    btn.textContent = '‚ûï Add Tokens';
});
</script>

<%- include('../partials/footer') %>
