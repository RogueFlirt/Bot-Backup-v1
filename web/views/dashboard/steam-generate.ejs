<%- include('_layout-start') %>

<div class="content-header">
    <h2>üéÆ Generate Steam Tokens</h2>
    <span class="badge badge-steam">Steam</span>
</div>

<div class="content-body">
    <div class="row-2">
        <!-- Upload Tokens -->
        <div class="card">
            <div class="card-title">üìÅ Upload Token File</div>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label>Select Game</label>
                    <select name="game_id" class="form-control" required>
                        <option value="">-- Select Game --</option>
                        <% games.forEach(g => { %>
                        <option value="<%= g.game_id %>"><%= g.game_name %> (Available: <%= g.stats?.available || 0 %>)</option>
                        <% }) %>
                    </select>
                </div>
                <div class="form-group">
                    <label>Account (Optional)</label>
                    <select name="account_id" class="form-control">
                        <option value="">-- No Account --</option>
                        <% accounts.forEach(a => { %>
                        <option value="<%= a.id %>"><%= a.account_name %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="form-group">
                    <label>Token File (.txt, one per line)</label>
                    <input type="file" name="token_file" class="form-control" accept=".txt" required>
                </div>
                <button type="submit" class="btn btn-primary">‚¨ÜÔ∏è Upload Tokens</button>
            </form>
            <div id="uploadResult" class="result-box" style="display:none;"></div>
        </div>

        <!-- Manual Entry -->
        <div class="card">
            <div class="card-title">‚úèÔ∏è Manual Token Entry</div>
            <form id="manualForm">
                <div class="form-group">
                    <label>Select Game</label>
                    <select name="game_id" class="form-control" required>
                        <option value="">-- Select Game --</option>
                        <% games.forEach(g => { %>
                        <option value="<%= g.game_id %>"><%= g.game_name %> (Available: <%= g.stats?.available || 0 %>)</option>
                        <% }) %>
                    </select>
                </div>
                <div class="form-group">
                    <label>Account (Optional)</label>
                    <select name="account_id" class="form-control">
                        <option value="">-- No Account --</option>
                        <% accounts.forEach(a => { %>
                        <option value="<%= a.id %>"><%= a.account_name %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tokens (one per line)</label>
                    <textarea name="tokens" class="form-control" rows="8" placeholder="XXXXX-XXXXX-XXXXX&#10;YYYYY-YYYYY-YYYYY&#10;..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">‚ûï Add Tokens</button>
            </form>
            <div id="manualResult" class="result-box" style="display:none;"></div>
        </div>
    </div>

    <!-- Token Stats -->
    <div class="card">
        <div class="card-title">üìä Current Token Inventory</div>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Game</th>
                        <th>Available</th>
                        <th>Used</th>
                        <th>Reserved</th>
                        <th>Total</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <% games.forEach(g => { %>
                    <tr>
                        <td><%= g.game_name %></td>
                        <td style="color: <%= g.stats?.available > 0 ? '#28a745' : '#dc3545' %>"><%= g.stats?.available || 0 %></td>
                        <td><%= g.stats?.used || 0 %></td>
                        <td><%= g.stats?.reserved || 0 %></td>
                        <td><%= g.stats?.total || 0 %></td>
                        <td>
                            <% if (g.stats?.available > 10) { %>
                            <span class="badge badge-success">Good</span>
                            <% } else if (g.stats?.available > 0) { %>
                            <span class="badge badge-warning">Low</span>
                            <% } else { %>
                            <span class="badge badge-failed">Empty</span>
                            <% } %>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
@media (max-width: 900px) { .row-2 { grid-template-columns: 1fr; } }
.result-box { margin-top: 15px; padding: 12px; border-radius: 6px; }
.result-box.success { background: rgba(40,167,69,0.2); border: 1px solid #28a745; color: #28a745; }
.result-box.error { background: rgba(220,53,69,0.2); border: 1px solid #dc3545; color: #dc3545; }
</style>

<script>
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const btn = form.querySelector('button');
    const result = document.getElementById('uploadResult');
    
    btn.disabled = true;
    btn.textContent = 'Uploading...';
    
    try {
        const formData = new FormData(form);
        const res = await fetch('/dashboard/steam/generate/upload', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();
        
        result.style.display = 'block';
        if (data.success) {
            result.className = 'result-box success';
            result.textContent = `‚úì Added ${data.added} tokens (${data.total} in file)`;
            form.reset();
            setTimeout(() => location.reload(), 1500);
        } else {
            result.className = 'result-box error';
            result.textContent = '‚úó ' + (data.error || 'Upload failed');
        }
    } catch (err) {
        result.style.display = 'block';
        result.className = 'result-box error';
        result.textContent = '‚úó ' + err.message;
    }
    
    btn.disabled = false;
    btn.textContent = '‚¨ÜÔ∏è Upload Tokens';
});

document.getElementById('manualForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const btn = form.querySelector('button');
    const result = document.getElementById('manualResult');
    
    btn.disabled = true;
    btn.textContent = 'Adding...';
    
    try {
        const res = await fetch('/dashboard/steam/generate/manual', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                game_id: form.game_id.value,
                account_id: form.account_id.value,
                tokens: form.tokens.value
            })
        });
        const data = await res.json();
        
        result.style.display = 'block';
        if (data.success) {
            result.className = 'result-box success';
            result.textContent = `‚úì Added ${data.added} tokens`;
            form.tokens.value = '';
            setTimeout(() => location.reload(), 1500);
        } else {
            result.className = 'result-box error';
            result.textContent = '‚úó ' + (data.error || 'Failed');
        }
    } catch (err) {
        result.style.display = 'block';
        result.className = 'result-box error';
        result.textContent = '‚úó ' + err.message;
    }
    
    btn.disabled = false;
    btn.textContent = '‚ûï Add Tokens';
});
</script>

<%- include('_layout-end') %>
