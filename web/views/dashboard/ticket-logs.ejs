<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Logs - Pub's Lounge</title>
    <link rel="stylesheet" href="/dashboard/static/css/dashboard.css">
    <style>
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .summary-card { background: var(--card-bg, #2a2a2a); border-radius: 8px; padding: 1rem; text-align: center; }
        .summary-card .number { font-size: 2rem; font-weight: bold; }
        .summary-card.opened .number { color: #22c55e; }
        .summary-card.success .number { color: #22c55e; }
        .summary-card.timeout .number { color: #f97316; }
        .summary-card.ghosted .number { color: #a855f7; }
        .summary-card.cancelled .number { color: #ef4444; }
        
        .filters { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; align-items: center; }
        .filters select, .filters input { padding: 0.5rem; border-radius: 4px; border: 1px solid #555; background: #2a2a2a; color: white; }
        
        .event-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold; display: inline-block; }
        .event-badge.opened { background: #22c55e; color: white; }
        .event-badge.closed { background: #ef4444; color: white; }
        .event-badge.success { background: #22c55e; color: white; }
        .event-badge.timeout { background: #f97316; color: white; }
        .event-badge.ghosted { background: #a855f7; color: white; }
        .event-badge.cancelled { background: #6b7280; color: white; }
        .event-badge.step_change { background: #3b82f6; color: white; }
        .event-badge.staff_action { background: #eab308; color: black; }
        .event-badge.cooldown_applied { background: #f97316; color: white; }
        .event-badge.cooldown_removed { background: #22c55e; color: white; }
        
        .export-btn { background: #22c55e; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; }
        .export-btn:hover { background: #16a34a; }
        
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; table-layout: fixed; }
        .data-table th, .data-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .data-table th { background: #1a1a1a; font-weight: 600; }
        .data-table tr:hover { background: #333; }
        .data-table th:nth-child(1), .data-table td:nth-child(1) { width: 160px; } /* Time */
        .data-table th:nth-child(2), .data-table td:nth-child(2) { width: 100px; } /* Event */
        .data-table th:nth-child(3), .data-table td:nth-child(3) { width: 120px; } /* User */
        .data-table th:nth-child(4), .data-table td:nth-child(4) { width: 150px; } /* Game */
        .data-table th:nth-child(5), .data-table td:nth-child(5) { width: 100px; } /* Staff */
        .data-table th:nth-child(6), .data-table td:nth-child(6) { width: auto; } /* Details */
        
        .pagination { display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: center; }
        .pagination a { padding: 0.5rem 1rem; background: #2a2a2a; color: white; text-decoration: none; border-radius: 4px; }
        .pagination a:hover { background: #444; }
        .pagination a.active { background: #f97316; }
        
        .empty-state { text-align: center; padding: 3rem; color: #888; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="logo">ğŸº</span>
                <h1>Pub's Lounge</h1>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/dashboard" class="nav-item">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span>Dashboard</span>
                </a>
                <a href="/dashboard/games" class="nav-item">
                    <span class="nav-icon">ğŸ®</span>
                    <span>Games</span>
                </a>
                <a href="/dashboard/accounts" class="nav-item">
                    <span class="nav-icon">ğŸ‘¤</span>
                    <span>Accounts</span>
                </a>
                <a href="/dashboard/tokens" class="nav-item">
                    <span class="nav-icon">ğŸ«</span>
                    <span>Tokens</span>
                </a>
                <a href="/dashboard/transcripts" class="nav-item">
                    <span class="nav-icon">ğŸ“œ</span>
                    <span>Transcripts</span>
                </a>
                
                <div class="nav-divider"></div>
                <div class="nav-section-title" style="padding: 8px 16px; font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; letter-spacing: 0.5px;">ğŸ¯ Ubisoft</div>
                <a href="/dashboard/ubisoft-games" class="nav-item">
                    <span class="nav-icon">ğŸ®</span>
                    <span>Ubisoft Games</span>
                </a>
                <a href="/dashboard/ubisoft-accounts" class="nav-item">
                    <span class="nav-icon">ğŸ‘¤</span>
                    <span>Ubisoft Accounts</span>
                </a>
                <a href="/dashboard/ubisoft-tokens" class="nav-item">
                    <span class="nav-icon">ğŸ«</span>
                    <span>Ubisoft Tokens</span>
                </a>
                <a href="/dashboard/ubisoft-activations" class="nav-item">
                    <span class="nav-icon">âœ…</span>
                    <span>Ubisoft Activations</span>
                </a>
                <div class="nav-divider"></div>
                
                <a href="/dashboard/analytics" class="nav-item">
                    <span class="nav-icon">ğŸ“ˆ</span>
                    <span>Analytics</span>
                </a>
                <a href="/dashboard/activations" class="nav-item">
                    <span class="nav-icon">âœ…</span>
                    <span>Activated Users</span>
                </a>
                
                <div class="nav-divider"></div>
                
                <a href="/dashboard/generate" class="nav-item">
                    <span class="nav-icon">âš¡</span>
                    <span>Generate Token</span>
                </a>
                <a href="/dashboard/ticket-logs" class="nav-item active">
                    <span class="nav-icon">ğŸ«</span>
                    <span>Ticket Logs</span>
                </a>
                <a href="/dashboard/audit-logs" class="nav-item">
                    <span class="nav-icon">ğŸ“‹</span>
                    <span>Audit Logs</span>
                </a>
                <a href="/dashboard/staff-activity" class="nav-item">
                <span class="nav-icon">â³</span>
                <span>Staff Activity</span>
            </a>
            <a href="/dashboard/macros" class="nav-item">
                <span class="nav-icon">ğŸ“</span>
                <span>Macros</span>
            </a>
            <a href="/dashboard/files" class="nav-item">
                    <span class="nav-icon">ğŸ“</span>
                    <span>File Manager</span>
                </a>
            </nav>
            
            <% if (user) { %>
            <div class="sidebar-footer">
                <div class="user-info">
                    <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png" alt="" class="user-avatar" onerror="this.style.display='none'">
                    <div class="user-details">
                        <span class="user-name"><%= user.username %></span>
                        <span class="user-role">Staff</span>
                    </div>
                </div>
                <a href="/dashboard/logout" class="logout-btn">Logout</a>
            </div>
            <% } %>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <h2>ğŸ“‹ Ticket Logs</h2>
            </header>
            
            <div class="content-body">
                <!-- Summary Cards -->
                <div class="summary-cards">
                    <div class="summary-card opened">
                        <div class="number"><%= summary?.opened || 0 %></div>
                        <div class="label">Opened (7d)</div>
                    </div>
                    <div class="summary-card success">
                        <div class="number"><%= summary?.success || 0 %></div>
                        <div class="label">Success</div>
                    </div>
                    <div class="summary-card timeout">
                        <div class="number"><%= summary?.timeout || 0 %></div>
                        <div class="label">Timeout</div>
                    </div>
                    <div class="summary-card ghosted">
                        <div class="number"><%= summary?.ghosted || 0 %></div>
                        <div class="label">Ghosted</div>
                    </div>
                    <div class="summary-card cancelled">
                        <div class="number"><%= summary?.cancelled || 0 %></div>
                        <div class="label">Cancelled</div>
                    </div>
                </div>
                
                <!-- Filters -->
                <form class="filters" method="GET" action="/dashboard/ticket-logs">
                    <select name="guild">
                        <option value="">All Servers</option>
                        <% if (guilds && guilds.length) { %>
                            <% guilds.forEach(g => { %>
                                <option value="<%= g.guild_id %>" <%= filters?.guildId === g.guild_id ? 'selected' : '' %>><%= g.guild_name || g.guild_id %></option>
                            <% }); %>
                        <% } %>
                    </select>
                    
                    <select name="eventType">
                        <option value="">All Events</option>
                        <option value="opened" <%= filters?.eventType === 'opened' ? 'selected' : '' %>>Opened</option>
                        <option value="success" <%= filters?.eventType === 'success' ? 'selected' : '' %>>Success</option>
                        <option value="closed" <%= filters?.eventType === 'closed' ? 'selected' : '' %>>Closed</option>
                        <option value="timeout" <%= filters?.eventType === 'timeout' ? 'selected' : '' %>>Timeout</option>
                        <option value="ghosted" <%= filters?.eventType === 'ghosted' ? 'selected' : '' %>>Ghosted</option>
                        <option value="cancelled" <%= filters?.eventType === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                        <option value="staff_action" <%= filters?.eventType === 'staff_action' ? 'selected' : '' %>>Staff Action</option>
                        <option value="cooldown_applied" <%= filters?.eventType === 'cooldown_applied' ? 'selected' : '' %>>Cooldown Applied</option>
                        <option value="cooldown_removed" <%= filters?.eventType === 'cooldown_removed' ? 'selected' : '' %>>Cooldown Removed</option>
                    </select>
                    
                    <input type="date" name="startDate" value="<%= filters?.startDate || '' %>" placeholder="Start Date">
                    <input type="date" name="endDate" value="<%= filters?.endDate || '' %>" placeholder="End Date">
                    
                    <button type="submit" class="export-btn">Filter</button>
                    <a href="/dashboard/ticket-logs/export?<%= Object.entries(filters || {}).map(([k,v]) => k + '=' + v).join('&') %>" class="export-btn" style="background: #3b82f6;">ğŸ“¥ Export CSV</a>
                </form>
                
                <!-- Logs Table -->
                <% if (logs && logs.length > 0) { %>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Event</th>
                            <th>User</th>
                            <th>Game</th>
                            <th>Staff</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% logs.forEach(log => { %>
                        <tr>
                            <td><%= new Date(log.created_at).toLocaleString() %></td>
                            <td><span class="event-badge <%= log.event_type || 'unknown' %>"><%= log.event_type || 'N/A' %></span></td>
                            <td title="<%= log.user_id || '' %>"><%= log.username || log.user_id || '-' %></td>
                            <td><%= log.game_name || log.game_id || '-' %></td>
                            <td><%= log.staff_member || log.staff_id || '-' %></td>
                            <td title="<%= log.event_details || '' %>"><%= log.event_details ? (typeof log.event_details === 'string' ? log.event_details.substring(0, 50) : JSON.stringify(log.event_details).substring(0, 50)) : '-' %></td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
                
                <!-- Pagination -->
                <% if (totalPages > 1) { %>
                <div class="pagination">
                    <% for (let i = 1; i <= totalPages; i++) { %>
                        <a href="?page=<%= i %>&<%= Object.entries(filters || {}).filter(([k]) => k !== 'page').map(([k,v]) => k + '=' + v).join('&') %>" class="<%= page === i ? 'active' : '' %>"><%= i %></a>
                    <% } %>
                </div>
                <% } %>
                
                <% } else { %>
                <div class="empty-state">
                    <p>ğŸ“­ No ticket logs found</p>
                    <p>Logs will appear here as tickets are opened and processed.</p>
                </div>
                <% } %>
            </div>
        </main>
    </div>
</body>
</html>
